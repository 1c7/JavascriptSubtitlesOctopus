<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/4.2.6/mediaelementplayer.min.css" />
    <style type="text/css">
        body {
            font-family: sans-serif;
        }
    </style>
</head>
<body>
<a href="index.html">Index</a><br><br>

<p>Multitrack video test</p>

<video width="800" height="480" controls="controls" preload="none" src="">
    <source src="/JavascriptSubtitlesOctopus/dash.mpd" />
    <track src="/JavascriptSubtitlesOctopus/test.ass" srclang="ts" label="Test Lang" kind="subtitles" type="application/x-ass">
</video>

<br>
<br>
<button onclick="toggleScriptMode('both');">Both Mode</button>
<button onclick="toggleScriptMode('asmjs');">ASM.JS Mode</button>
<button onclick="toggleScriptMode('wasm');">WASM Mode</button>

<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/4.2.6/mediaelement-and-player.js" integrity="sha256-GHaL+e25urcUodCnzBxIywtm9yXVT5/SDfFj2yM/Qwo=" crossorigin="anonymous"></script>
<script src="/JavascriptSubtitlesOctopus/js/both/subtitles-octopus.js"></script>

<script>
    var workurl = '/JavascriptSubtitlesOctopus/js/both/subtitles-octopus-worker.js'
    var toggleScriptMode = function(mode) {
        if (mode == "asmjs") {
            setasmjsmode();
            window.location.reload(false); 
        } else if (mode == "wasm") {
            setwasmmode();
            window.location.reload(false); 
        } else {
            setbothmode();
            window.location.reload(false); 
        }
    };

    var setbothmode = function() {
        localStorage.setItem("scriptmode","both");
        workurl = '/JavascriptSubtitlesOctopus/js/both/subtitles-octopus-worker.js'
    };

    var setasmjsmode = function() {
        localStorage.setItem("scriptmode","asmjs");
        workurl = '/JavascriptSubtitlesOctopus/js/asmjs/subtitles-octopus-worker.js'
    };

    var setwasmmode = function() {
        localStorage.setItem("scriptmode","wasm");
        workurl = '/JavascriptSubtitlesOctopus/js/wasm/subtitles-octopus-worker.js'
    };
    
    mejs.i18n.language('en');
    $('video').mediaelementplayer({
        success: function (player, node) {
            var video = node;
            
            player.addEventListener('captionschange', function(e) {
                if("undefined" != typeof Storage){
                    if (localStorage.getItem("scriptmode") === "both") {
                        setbothmode();
                    } else if (localStorage.getItem("scriptmode") === "asmjs") {
                        setasmjsmode();
                    } else if (localStorage.getItem("scriptmode") === "wasm") {
                        setwasmmode();
                    } else {
                        setbothmode();
                    }
                }
                console.log('Charging Track ' + e.detail.caption);
                if (e.detail.caption !== null) {
                    window.SubtitlesOctopusOnLoad = function () {
                    var options = {
                        video: video,
                        subUrl: e.detail.caption.src,
                        fonts: ['/JavascriptSubtitlesOctopus/fonts/CabinCondensed-Regular.ttf', '/JavascriptSubtitlesOctopus/fonts/SourceSansPro-SemiBold.ttf'],
                        //onReady: onReadyFunction,
                        //debug: true,
                        workerUrl: workurl
                    };
                        window.octopusInstance = new SubtitlesOctopus(options); // You can experiment in console
                    };
                    if (SubtitlesOctopus) {
                        if (window.octopusInstance) {
                            window.octopusInstance.dispose();
                        }
                        
                        SubtitlesOctopusOnLoad();
                    }
                } else {
                    if (SubtitlesOctopus) {
                        console.log('Disable Track ' + e.detail.caption);
                        window.octopusInstance.dispose();
                    }
                }
                
            });

            $(player).closest('.mejs__container').attr('lang', mejs.i18n.language());

            $('html').attr('lang', mejs.i18n.language());
        }
    });
</script>
</body>
</html>